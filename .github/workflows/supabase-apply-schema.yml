name: Apply Supabase schema (manual)

on:
  workflow_dispatch: {}
  push:
    branches:
      - cursor/vistas-faltantes-supabase-2d2b
    paths:
      - supabase/schema.sql

concurrency:
  group: supabase-apply-schema-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  apply:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # Connection string Postgres (REQUIRED). Example:
      # postgresql://postgres:<DB_PASSWORD>@db.<PROJECT_REF>.supabase.co:5432/postgres
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validar secret de DB (skip con warning)
        id: validate
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_DB_URL:-}" ]]; then
            echo "::warning::Falta el secret SUPABASE_DB_URL (connection string Postgres). No se aplicará el schema."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Instalar psql (postgresql-client)
        if: steps.validate.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql --version

      - name: Aplicar supabase/schema.sql
        if: steps.validate.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "Aplicando schema.sql a Supabase (sin imprimir credenciales)..."
          # Nota: GitHub-hosted runners suelen no tener conectividad IPv6. Si el host resuelve solo a AAAA,
          # la conexión fallará con "Network is unreachable". En ese caso, usa el connection string de
          # "Connection pooling" (pooler) de Supabase como SUPABASE_DB_URL (normalmente IPv4).
          host="$(python3 - <<'PY'
import os
from urllib.parse import urlparse
u=os.environ.get("SUPABASE_DB_URL","")
print(urlparse(u).hostname or "")
PY
)"
          if [[ -n "${host:-}" ]]; then
            ipv4="$(getent ahostsv4 "$host" 2>/dev/null | awk '{print $1; exit}' || true)"
            ipv6="$(getent ahostsv6 "$host" 2>/dev/null | awk '{print $1; exit}' || true)"
            echo "DB host: $host (ipv4=${ipv4:-none} ipv6=${ipv6:-none})"
            if [[ -z "${ipv4:-}" && -n "${ipv6:-}" ]]; then
              echo "::error::El host de SUPABASE_DB_URL resuelve solo a IPv6. Cambia SUPABASE_DB_URL al string de Connection Pooling (pooler.supabase.com) en Supabase → Project Settings → Database → Connection pooling."
              exit 2
            fi
          fi
          psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 -f supabase/schema.sql
          echo "OK: schema aplicado."

