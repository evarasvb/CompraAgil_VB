name: Apply Supabase schema (manual)

on:
  workflow_dispatch: {}
  push:
    branches:
      - cursor/vistas-faltantes-supabase-2d2b
    paths:
      - supabase/schema.sql

concurrency:
  group: supabase-apply-schema-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  apply:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # Connection string Postgres (REQUIRED). Example:
      # postgresql://postgres:<DB_PASSWORD>@db.<PROJECT_REF>.supabase.co:5432/postgres
      SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validar secret de DB (skip con warning)
        id: validate
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_DB_URL:-}" ]]; then
            echo "::warning::Falta el secret SUPABASE_DB_URL (connection string Postgres). No se aplicarÃ¡ el schema."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Instalar psql (postgresql-client)
        if: steps.validate.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          psql --version

      - name: Aplicar supabase/schema.sql
        if: steps.validate.outputs.skip != 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "Aplicando schema.sql a Supabase (sin imprimir credenciales)..."
          psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 -f supabase/schema.sql
          echo "OK: schema aplicado."

