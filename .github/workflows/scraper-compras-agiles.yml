name: Scraper Compras Ágiles (API Client)

on:
  schedule:
    # Diario (UTC). Usa "ayer" por defecto.
    - cron: '20 6 * * *'
  workflow_dispatch:
    inputs:
      from:
        description: "Fecha desde (YYYY-MM-DD). Default: ayer (UTC)"
        required: false
        default: ""
      to:
        description: "Fecha hasta (YYYY-MM-DD). Default: misma que from"
        required: false
        default: ""
      pages:
        description: "Páginas a procesar (entero). Default: 1"
        required: false
        default: "1"
      max_ficha:
        description: "Máximo de fichas a descargar (entero). Default: vacío (sin límite)"
        required: false
        default: ""

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mercadopublico-scraper/package-lock.json

      - name: Validar secrets requeridos
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${SUPABASE_URL:-}" ]]; then
            echo "::error::Falta el secret SUPABASE_URL."
            exit 1
          fi
          if [[ -z "${SUPABASE_SERVICE_KEY:-}" && -z "${SUPABASE_KEY:-}" ]]; then
            echo "::error::Falta el secret SUPABASE_SERVICE_KEY o SUPABASE_KEY."
            exit 1
          fi

      - name: Crear .env con secrets
        working-directory: mercadopublico-scraper
        shell: bash
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          set -euo pipefail
          echo "SUPABASE_URL=${SUPABASE_URL}" > .env
          if [[ -n "${SUPABASE_SERVICE_KEY:-}" ]]; then
            echo "SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}" >> .env
          fi
          if [[ -n "${SUPABASE_KEY:-}" ]]; then
            echo "SUPABASE_KEY=${SUPABASE_KEY}" >> .env
          fi
          echo ".env creado con $(wc -l < .env) variables."

      - name: Instalar dependencias (sin Chromium)
        working-directory: mercadopublico-scraper
        env:
          PUPPETEER_SKIP_DOWNLOAD: '1'
        shell: bash
        run: |
          set -euo pipefail
          node --version
          npm --version
          npm install

      - name: Ejecutar API client y guardar JSON temporal
        id: run
        working-directory: mercadopublico-scraper
        shell: bash
        run: |
          set -euo pipefail
          FROM_IN="${{ github.event_name == 'workflow_dispatch' && inputs.from || '' }}"
          TO_IN="${{ github.event_name == 'workflow_dispatch' && inputs.to || '' }}"
          PAGES_IN="${{ github.event_name == 'workflow_dispatch' && inputs.pages || '1' }}"
          MAX_FICHA_IN="${{ github.event_name == 'workflow_dispatch' && inputs.max_ficha || '' }}"

          YESTERDAY="$(date -u -d 'yesterday' +%F)"
          FROM="${FROM_IN:-$YESTERDAY}"
          TO="${TO_IN:-$FROM}"
          TMP_JSON="$(mktemp)"
          echo "from=${FROM} to=${TO} pages=${PAGES_IN} max_ficha=${MAX_FICHA_IN:-<none>}"

          args=(--from "${FROM}" --to "${TO}" --pages "${PAGES_IN}" --status all --include-ficha)
          if [[ -n "${MAX_FICHA_IN:-}" ]]; then
            args+=(--max-ficha "${MAX_FICHA_IN}")
          fi

          # Retry simple (API puede fallar transitoriamente)
          max=3
          for i in $(seq 1 $max); do
            echo "Intento $i/$max: node api-client.js"
            if node api-client.js "${args[@]}" > "${TMP_JSON}"; then
              break
            fi
            if [[ "$i" -lt "$max" ]]; then
              sleep_s=$((10 * (2 ** (i-1))))
              echo "Fallo intento $i. Esperando ${sleep_s}s..."
              sleep "$sleep_s"
            else
              echo "::error::api-client falló $max veces seguidas."
              exit 1
            fi
          done

          # Validar que sea JSON parseable
          node -e 'JSON.parse(require("fs").readFileSync(process.argv[1],"utf8")); console.log("JSON OK");' "${TMP_JSON}"
          echo "tmp_json=${TMP_JSON}" >> "$GITHUB_OUTPUT"
          echo "Bytes JSON: $(wc -c < "${TMP_JSON}")"

      - name: Subir resultados a Supabase
        working-directory: mercadopublico-scraper
        shell: bash
        run: |
          set -euo pipefail
          node api_client_upload.js --input "${{ steps.run.outputs.tmp_json }}"

      - name: Enriquecer instituciones (métricas internas)
        working-directory: mercadopublico-scraper
        shell: bash
        run: |
          set -euo pipefail
          node instituciones_enrich.js --input "${{ steps.run.outputs.tmp_json }}"

      - name: Enriquecer instituciones (ficha comprador)
        working-directory: mercadopublico-scraper
        shell: bash
        run: |
          set -euo pipefail
          node comprador_ficha_enrich.js --input "${{ steps.run.outputs.tmp_json }}"

      - name: Limpiar archivo temporal
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          f="${{ steps.run.outputs.tmp_json }}"
          if [[ -n "${f:-}" && -f "${f}" ]]; then
            rm -f "${f}"
          fi

