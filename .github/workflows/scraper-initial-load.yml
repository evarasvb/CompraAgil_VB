name: Scraper Compras Ágiles - Carga inicial (manual)

on:
  workflow_dispatch:
    inputs:
      pages:
        description: "Páginas a procesar (default 5)"
        required: false
        default: "5"
      date_from:
        description: "Fecha inicio (YYYY-MM-DD). Vacío = hace 7 días (UTC)"
        required: false
        default: ""
      date_to:
        description: "Fecha fin (YYYY-MM-DD). Vacío = hoy (UTC)"
        required: false
        default: ""

concurrency:
  group: mercadopublico-scraper-initial-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  scrape_initial:
    name: Carga inicial (sin incremental)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: mercadopublico-scraper/package.json

      - name: Validar secrets requeridos
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.SUPABASE_URL }}" ]]; then
            echo "::error::Falta el secret SUPABASE_URL (Settings → Secrets and variables → Actions)."
            exit 1
          fi
          if [[ -z "${{ secrets.SUPABASE_KEY }}" ]]; then
            echo "::error::Falta el secret SUPABASE_KEY (Settings → Secrets and variables → Actions)."
            exit 1
          fi
          echo "Secrets OK (no se imprime su contenido)."

      - name: Crear archivo .env para dotenv (carga inicial)
        shell: bash
        run: |
          set -euo pipefail
          rm -f mercadopublico-scraper/.env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> mercadopublico-scraper/.env
          echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> mercadopublico-scraper/.env
          echo "INCREMENTAL_MODE=false" >> mercadopublico-scraper/.env

          echo ".env creado. Variables presentes (sin valores):"
          grep -E '^(SUPABASE_URL|SUPABASE_KEY|INCREMENTAL_MODE)=' mercadopublico-scraper/.env | cut -d= -f1
          echo "Líneas en .env: $(wc -l < mercadopublico-scraper/.env)"

      - name: Instalar dependencias
        working-directory: mercadopublico-scraper
        shell: bash
        run: |
          set -euo pipefail
          node --version
          npm --version
          npm install

      - name: Ejecutar scraper (sin incremental, 5 páginas)
        working-directory: mercadopublico-scraper
        shell: bash
        run: |
          set -euo pipefail
          PAGES="${{ inputs.pages }}"
          if [[ -z "${PAGES}" ]]; then PAGES="5"; fi

          FROM="${{ inputs.date_from }}"
          TO="${{ inputs.date_to }}"
          if [[ -z "${FROM}" ]]; then FROM="$(date -u -d '7 days ago' +%Y-%m-%d)"; fi
          if [[ -z "${TO}" ]]; then TO="$(date -u +%Y-%m-%d)"; fi

          echo "Ejecutando carga inicial: pages=${PAGES} from=${FROM} to=${TO}"
          node scraper.js --no-incremental --pages "${PAGES}" --from "${FROM}" --to "${TO}"

